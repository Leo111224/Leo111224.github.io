<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="wechat-webview-api-version" content="1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>扫码领号系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <style>
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        input:focus { -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center justify-center p-4">
    <div class="max-w-md w-full bg-white rounded-xl shadow-lg p-6 md:p-8">
        <!-- 管理员配置页 -->
        <div id="configPage" class="fade-in">
            <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">领号二维码配置</h1>
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">总号码数量</label>
                <input 
                    type="number" 
                    id="totalNumInput" 
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="如：50"
                    min="1"
                    value="10"
                >
            </div>
            <div class="mb-6">
                <label class="block text-gray-700 mb-2">二维码有效时间（分钟）</label>
                <input 
                    type="number" 
                    id="validTimeInput" 
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="如：30"
                    min="1"
                    value="60"
                >
            </div>
            <button id="createQrBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                生成领号二维码
            </button>
            
            <div id="qrShowArea" class="hidden fade-in mt-6 flex flex-col items-center">
                <p class="text-gray-600 mb-3">扫码领号 | 有效期至：<span id="expireTimeText"></span></p>
                <canvas id="qrCanvas" class="w-64 h-64"></canvas>
                <button id="downloadQrBtn" class="mt-4 bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                    下载二维码
                </button>
            </div>
            <div id="configError" class="hidden text-red-500 text-center mt-4"></div>
        </div>

        <!-- 用户领号页 -->
        <div id="userPage" class="hidden fade-in">
            <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">填写信息领取号码</h1>
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">您的姓名</label>
                <input 
                    type="text" 
                    id="userNameInput" 
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="请输入姓名"
                >
            </div>
            <p class="text-gray-600 text-center mb-4">本次共 <span id="showTotalNum" class="font-bold text-blue-600">0</span> 个号码，每人限领1个</p>
            <button id="getNumberBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                领取号码
            </button>
            
            <div id="resultArea" class="hidden fade-in mt-6 text-center">
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 mb-4">
                    <p class="text-lg text-gray-700 mb-2">领号成功！</p>
                    <p class="text-gray-600 mb-1">姓名：<span id="resultName" class="font-bold"></span></p>
                    <p class="text-4xl font-bold text-red-600 my-2" id="resultNumber"></p>
                    <p class="text-sm text-gray-500">此号码唯一，请勿重复领取</p>
                </div>
                <button id="backBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                    返回
                </button>
            </div>
            <div id="userError" class="hidden text-red-500 text-center mt-4"></div>
        </div>
    </div>

    <script>
        const USED_NUMBERS = 'used_numbers_' + new Date().toLocaleDateString().replace(/\//g, '_');
        const BASE_URL = 'https://Leo111224.github.io/';

        const el = {
            configPage: document.getElementById('configPage'),
            totalNumInput: document.getElementById('totalNumInput'),
            validTimeInput: document.getElementById('validTimeInput'),
            createQrBtn: document.getElementById('createQrBtn'),
            qrShowArea: document.getElementById('qrShowArea'),
            expireTimeText: document.getElementById('expireTimeText'),
            qrCanvas: document.getElementById('qrCanvas'),
            downloadQrBtn: document.getElementById('downloadQrBtn'),
            configError: document.getElementById('configError'),
            userPage: document.getElementById('userPage'),
            userNameInput: document.getElementById('userNameInput'),
            showTotalNum: document.getElementById('showTotalNum'),
            getNumberBtn: document.getElementById('getNumberBtn'),
            resultArea: document.getElementById('resultArea'),
            resultName: document.getElementById('resultName'),
            resultNumber: document.getElementById('resultNumber'),
            backBtn: document.getElementById('backBtn'),
            userError: document.getElementById('userError')
        };

        let totalNumbers = 0;
        let expireTimestamp = 0;

        window.onload = function() {
            try {
                parseUrlParams();
                bindEvents();
            } catch (e) {
                el.configPage.classList.remove('hidden');
                el.userPage.classList.add('hidden');
                showConfigError('页面初始化失败：' + e.message);
            }
        };

        function parseUrlParams() {
            let total = 0;
            let expire = 0;
            const params = new URLSearchParams(window.location.search);
            total = parseInt(params.get('total')) || 0;
            expire = parseInt(params.get('expire')) || 0;

            if (total <= 0 || expire <= 0) {
                const search = window.location.search.slice(1);
                const pairs = search.split('&');
                pairs.forEach(pair => {
                    const [key, val] = pair.split('=');
                    if (key === 'total' && val) total = parseInt(decodeURIComponent(val)) || 0;
                    if (key === 'expire' && val) expire = parseInt(decodeURIComponent(val)) || 0;
                });
            }

            totalNumbers = total;
            expireTimestamp = expire;

            if (totalNumbers > 0 && expireTimestamp > 0 && !isNaN(expireTimestamp)) {
                el.configPage.classList.add('hidden');
                el.userPage.classList.remove('hidden');
                el.showTotalNum.textContent = totalNumbers;
                
                if (Date.now() > expireTimestamp) {
                    showUserError('二维码已过期，请联系管理员重新生成');
                    el.getNumberBtn.disabled = true;
                    el.getNumberBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                }
            }
        }

        function bindEvents() {
            el.createQrBtn.addEventListener('click', createQrCode);
            el.downloadQrBtn.addEventListener('click', downloadQrCode);
            el.getNumberBtn.addEventListener('click', getUniqueNumber);
            el.backBtn.addEventListener('click', () => window.location.href = BASE_URL);
            document.addEventListener('keypress', e => e.key === 'Enter' && createQrCode());
        }

        function createQrCode() {
            hideConfigError();
            const total = parseInt(el.totalNumInput.value.trim());
            const validTime = parseInt(el.validTimeInput.value.trim());

            if (isNaN(total) || total < 1) {
                showConfigError('请输入有效的总号码数（至少1个）');
                return;
            }
            if (isNaN(validTime) || validTime < 1) {
                showConfigError('请输入有效的有效期（至少1分钟）');
                return;
            }

            const now = Date.now();
            const expireTime = now + validTime * 60 * 1000;
            el.expireTimeText.textContent = new Date(expireTime).toLocaleString();
            const qrContent = `${BASE_URL}?total=${total}&expire=${expireTime}`;

            try {
                const ctx = el.qrCanvas.getContext('2d');
                ctx.clearRect(0, 0, el.qrCanvas.width, el.qrCanvas.height);
                QRCode.toCanvas(el.qrCanvas, qrContent, {
                    width: 256,
                    margin: 1,
                    color: { dark: '#000', light: '#fff' }
                }, err => {
                    if (err) {
                        showConfigError('二维码生成失败：' + err.message);
                        return;
                    }
                    el.qrShowArea.classList.remove('hidden');
                });
            } catch (err) {
                showConfigError('生成失败：' + err.message);
            }
        }

        function downloadQrCode() {
            try {
                const link = document.createElement('a');
                link.download = `领号二维码_总数${el.totalNumInput.value}_有效期${el.validTimeInput.value}分钟.png`;
                link.href = el.qrCanvas.toDataURL('image/png');
                link.click();
            } catch (err) {
                showConfigError('下载失败：' + err.message);
            }
        }

        function getUniqueNumber() {
            hideUserError();
            const userName = el.userNameInput.value.trim();
            if (!userName) {
                showUserError('请输入您的姓名');
                return;
            }

            let usedList = JSON.parse(localStorage.getItem(USED_NUMBERS) || '[]');
            if (usedList.length >= totalNumbers) {
                showUserError('所有号码已被领取完毕！');
                return;
            }

            let randomNum;
            do {
                randomNum = Math.floor(Math.random() * totalNumbers) + 1;
            } while (usedList.includes(randomNum));

            usedList.push(randomNum);
            localStorage.setItem(USED_NUMBERS, JSON.stringify(usedList));
            el.resultName.textContent = userName;
            el.resultNumber.textContent = randomNum;
            el.resultArea.classList.remove('hidden');
            el.getNumberBtn.disabled = true;
        }

        function showConfigError(msg) { el.configError.textContent = msg; el.configError.classList.remove('hidden'); }
        function hideConfigError() { el.configError.classList.add('hidden'); el.configError.textContent = ''; }
        function showUserError(msg) { el.userError.textContent = msg; el.userError.classList.remove('hidden'); }
        function hideUserError() { el.userError.classList.add('hidden'); el.userError.textContent = ''; }
    </script>
</body>
</html>
